import pickle
from django.shortcuts import render, redirect
from .models import TodoItem
import os 
from django.conf import settings

TODO_FILE = os.path.join(settings.BASE_DIR, 'todos.pkl')

def index(request):
    # Load to-do items from pickle file
    try:
        with open('todos.pkl', 'rb') as f:
            print(f)
            todos = pickle.load(f)  
    except FileNotFoundError:
        todos = []
        with open(TODO_FILE, 'wb') as f:
            pickle.dump(todos, f)

    if request.method == 'POST':
        title = request.POST.get('todo')
        if title:
            new_todo = TodoItem(title=title)
            new_todo.save()
            todos.append(new_todo)
            with open('todos.pkl', 'wb') as f:
                pickle.dump(todos, f)
        return redirect('index')

    return render(request, 'index.html', {'todos': todos})

def mark_complete(request, todo_id):
    todo = TodoItem.objects.get(id=todo_id)
    todo.completed = True
    todo.save()

    # Load existing to-dos
    with open('todos.pkl', 'rb') as f:
        todos = pickle.load(f)

    # Update status
    for t in todos:
        if t.id == todo_id:
            t.completed = True

    # Save updated to-dos
    with open('todos.pkl', 'wb') as f:
        pickle.dump(todos, f)

    return redirect('index')
